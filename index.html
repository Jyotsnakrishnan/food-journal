<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meal Journal PWA</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // We need to pull the icons from the Lucide library since we can't 'import' them
        const { Camera, Calendar, Share, Trash2, Plus, X, Printer, FileDown, ChefHat } = lucide;
        const { useState, useEffect, useRef } = React;

        // --- Utility: Image Compression ---
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 350;
                        const MAX_HEIGHT = 350;
                        let width = img.width;
                        let height = img.height;
                        if (width > height) { if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } }
                        else { if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; } }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    };
                };
            });
        };

        function App() {
            const [entries, setEntries] = useState([]);
            const [viewMode, setViewMode] = useState('list');
            const [loading, setLoading] = useState(false);
            const [newNote, setNewNote] = useState('');
            const fileInputRef = useRef(null);

            useEffect(() => {
                const saved = localStorage.getItem('meal_journal_entries');
                if (saved) setEntries(JSON.parse(saved));
                
                // Register Service Worker
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('sw.js');
                }
            }, []);

            useEffect(() => {
                localStorage.setItem('meal_journal_entries', JSON.stringify(entries));
            }, [entries]);

            const handleFileSelect = async (e) => {
                if (e.target.files && e.target.files[0]) {
                    setLoading(true);
                    const compressedBase64 = await compressImage(e.target.files[0]);
                    const now = new Date();
                    const newEntry = {
                        id: Date.now(),
                        image: compressedBase64,
                        date: now.toLocaleDateString(),
                        time: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                        note: 'No notes added.'
                    };
                    setEntries([newEntry, ...entries]);
                    setLoading(false);
                    setViewMode('list');
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 pb-20">
                    <header className="flex justify-between items-center p-4 bg-white shadow-sm border-b sticky top-0 z-10">
                        <div className="flex items-center gap-2 text-green-700 font-bold text-xl">
                            <ChefHat /> <span>MealLog</span>
                        </div>
                    </header>

                    <main className="max-w-md mx-auto p-4 space-y-4">
                        {entries.length === 0 ? (
                            <div className="text-center py-20 text-gray-400">
                                <Camera className="mx-auto mb-2 opacity-20" size={48} />
                                <p>No meals yet. Tap the camera!</p>
                            </div>
                        ) : (
                            entries.map(entry => (
                                <div key={entry.id} className="bg-white rounded-2xl overflow-hidden shadow-sm border">
                                    <img src={entry.image} className="w-full aspect-square object-cover" />
                                    <div className="p-4">
                                        <div className="flex justify-between text-xs text-gray-400 mb-2">
                                            <span>{entry.date}</span> <span>{entry.time}</span>
                                        </div>
                                        <textarea 
                                            className="w-full text-sm bg-transparent focus:outline-none"
                                            value={entry.note}
                                            onChange={(e) => {
                                                const updated = entries.map(ent => ent.id === entry.id ? {...ent, note: e.target.value} : ent);
                                                setEntries(updated);
                                            }}
                                        />
                                        <button onClick={() => setEntries(entries.filter(e => e.id !== entry.id))} className="text-red-300 mt-2">
                                            <Trash2 size={16} />
                                        </button>
                                    </div>
                                </div>
                            ))
                        )}
                    </main>

                    {loading && <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 text-white">Compressing...</div>}

                    <button 
                        onClick={() => fileInputRef.current.click()}
                        className="fixed bottom-6 right-6 bg-green-600 text-white p-4 rounded-full shadow-lg"
                    >
                        <Camera />
                    </button>
                    <input type="file" accept="image/*" capture="environment" ref={fileInputRef} className="hidden" onChange={handleFileSelect} />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
